<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒê·¼ ë‹¨ì–´ ê²Œì„ - {{ room_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #6200ea;
            --secondary-color: #b388ff;
            --correct-color: #4caf50;
            --present-color: #ff9800;
            --absent-color: #9e9e9e;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
            --confirmed-color: #ff9800;
            --excluded-color: #ff5252;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .player-list, .game-board, .leaderboard {
                grid-column: 1;
            }
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            background-color: var(--card-color);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .player-list {
            grid-column: 1 / 2;
        }

        .game-board {
            grid-column: 2 / 3;
        }

        .leaderboard {
            grid-column: 3 / 4;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .player-item:hover {
            background-color: #e0e0e0;
        }

        .player-item.current {
            background-color: var(--secondary-color);
            color: white;
        }

        .player-item.win {
            background-color: var(--correct-color);
            color: white;
        }

        .player-item.lose {
            background-color: var(--absent-color);
            color: white;
        }

        .player-status {
            display: flex;
            align-items: center;
        }

        .status-icon {
            margin-right: 5px;
        }

        .input-section {
            display: flex;
            margin-bottom: 20px;
        }

        #guess-input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid var(--primary-color);
            border-radius: 5px 0 0 5px;
            font-size: 16px;
        }

        #submit-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #submit-btn:hover {
            background-color: var(--secondary-color);
        }

        .restart-btn {
            display: none;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .restart-btn:hover {
            background-color: var(--secondary-color);
        }

        .game-over-message {
            display: none;
            padding: 15px;
            margin: 20px 0;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .guess-grid {
            margin-top: 20px;
        }

        .guess-result.card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .guess-text {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-color);
        }

        .hint-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hint-icon {
            font-size: 1.6em;
            transition: transform 0.2s ease;
        }

        .hint-icon:hover {
            transform: scale(1.2);
        }

        #guess-grid {
            margin-top: 20px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 8px;
            min-height: 200px;
        }

        .player-selector {
            margin-bottom: 20px;
        }

        .player-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            font-size: 1em;
        }

        .attempts-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .attempts-count {
            color: var(--primary-color);
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            10% { transform: translateX(-5px); }
            20% { transform: translateX(5px); }
            30% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            60% { transform: translateX(5px); }
            70% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            90% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .hint-guide {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .keyboard {
            margin-top: 20px;
            padding: 15px;
            background-color: #eee;
            border-radius: 10px;
        }

        .keyboard-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .key {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 0 4px 4px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .key:hover {
            background-color: #f0f0f0;
        }

        .key.confirmed {
            background-color: var(--confirmed-color);
            color: white;
            border-color: var(--confirmed-color);
        }

        .key.excluded {
            background-color: var(--excluded-color);
            color: white;
            border-color: var(--excluded-color);
        }
        
        .key-special {
            width: auto;
            padding: 0 15px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .leaderboard-item:nth-child(1) {
            background-color: gold;
            font-weight: bold;
        }
        
        .leaderboard-item:nth-child(2) {
            background-color: silver;
        }
        
        .leaderboard-item:nth-child(3) {
            background-color: #cd7f32;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ìŒê·¼ ë‹¨ì–´ ê²Œì„</h1>
            <div>ë°© ì´ë¦„: {{ room_name }} | ì‚¬ìš©ì: {{ username }}</div>
        </div>

        <div class="player-list card">
            <h2>í”Œë ˆì´ì–´ ëª©ë¡</h2>
            <div id="player-list-container">
                <!-- í”Œë ˆì´ì–´ ëª©ë¡ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <div class="game-board card">
            <div class="player-selector">
                <select id="player-select" onchange="switchPlayer(this.value)">
                    <option value="{{ username }}">ë‚´ ê²Œì„</option>
                    <!-- ë‹¤ë¥¸ í”Œë ˆì´ì–´ëŠ” ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </select>
            </div>
            
            <h2><span id="current-player">{{ username }}</span>ë‹˜ì˜ ê²Œì„</h2>
            
            <div class="hint-guide">
                <div class="hint-item">
                    <span class="hint-icon">ğŸ¥•</span> ì •í™•íˆ ì¼ì¹˜
                </div>
                <div class="hint-item">
                    <span class="hint-icon">ğŸ„</span> ì²« ììŒ í¬í•¨ 2ê°œ ì´ìƒ ì¼ì¹˜
                </div>
                <div class="hint-item">
                    <span class="hint-icon">ğŸ§„</span> ì²« ììŒ ë¶ˆì¼ì¹˜, ë‚˜ë¨¸ì§€ 2ê°œ ì´ìƒ ì¼ì¹˜
                </div>
                <div class="hint-item">
                    <span class="hint-icon">ğŸ†</span> ììŒÂ·ëª¨ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì¼ì¹˜
                </div>
                <div class="hint-item">
                    <span class="hint-icon">ğŸŒ</span> ë°˜ëŒ€í¸ ê¸€ìì—ì„œ 1ê°œ ì´ìƒ ì¼ì¹˜
                </div>
                <div class="hint-item">
                    <span class="hint-icon">ğŸ</span> ì™„ì „ ë¶ˆì¼ì¹˜
                </div>
            </div>

            <div class="attempts-info">
                <span>ë‚¨ì€ ê¸°íšŒ: <span id="attempts-count" class="attempts-count">7</span></span>
                <span>í˜„ì¬ ìƒíƒœ: <span id="game-status">ì§„í–‰ ì¤‘</span></span>
            </div>
            
            <div class="input-section" id="input-section">
                <input type="text" id="guess-input" maxlength="2" placeholder="ë‘ ê¸€ì ì…ë ¥" autocomplete="off">
                <button id="submit-btn">ì œì¶œ</button>
            </div>

            <div id="guess-grid" class="guess-grid">
                <!-- ì¶”ì¸¡ ê²°ê³¼ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
            
            <div class="game-over-message" id="game-over-message"></div>
            <button id="restart-btn" class="restart-btn">ìƒˆ ê²Œì„ ì‹œì‘</button>
            
            <!-- ê°€ìƒ í‚¤ë³´ë“œ ì¶”ê°€ -->
            <div class="keyboard">
                <div class="keyboard-title">ìëª¨ìŒ íŒíŠ¸</div>
                <div class="keyboard-row">
                    <div class="key" data-char="ã„±">ã„±</div>
                    <div class="key" data-char="ã„²">ã„²</div>
                    <div class="key" data-char="ã„´">ã„´</div>
                    <div class="key" data-char="ã„·">ã„·</div>
                    <div class="key" data-char="ã„¸">ã„¸</div>
                    <div class="key" data-char="ã„¹">ã„¹</div>
                    <div class="key" data-char="ã…">ã…</div>
                    <div class="key" data-char="ã…‚">ã…‚</div>
                    <div class="key" data-char="ã…ƒ">ã…ƒ</div>
                    <div class="key" data-char="ã……">ã……</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-char="ã…†">ã…†</div>
                    <div class="key" data-char="ã…‡">ã…‡</div>
                    <div class="key" data-char="ã…ˆ">ã…ˆ</div>
                    <div class="key" data-char="ã…‰">ã…‰</div>
                    <div class="key" data-char="ã…Š">ã…Š</div>
                    <div class="key" data-char="ã…‹">ã…‹</div>
                    <div class="key" data-char="ã…Œ">ã…Œ</div>
                    <div class="key" data-char="ã…">ã…</div>
                    <div class="key" data-char="ã…">ã…</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-char="ã…">ã…</div>
                    <div class="key" data-char="ã…">ã…</div>
                    <div class="key" data-char="ã…‘">ã…‘</div>
                    <div class="key" data-char="ã…’">ã…’</div>
                    <div class="key" data-char="ã…“">ã…“</div>
                    <div class="key" data-char="ã…”">ã…”</div>
                    <div class="key" data-char="ã…•">ã…•</div>
                    <div class="key" data-char="ã…–">ã…–</div>
                    <div class="key" data-char="ã…—">ã…—</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-char="ã…›">ã…›</div>
                    <div class="key" data-char="ã…œ">ã…œ</div>
                    <div class="key" data-char="ã… ">ã… </div>
                    <div class="key" data-char="ã…¡">ã…¡</div>
                    <div class="key" data-char="ã…£">ã…£</div>
                    <div class="key" data-char="ã…˜">ã…˜</div>
                    <div class="key" data-char="ã…™">ã…™</div>
                    <div class="key" data-char="ã…š">ã…š</div>
                    <div class="key" data-char="ã…">ã…</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-char="ã…">ã…</div>
                    <div class="key" data-char="ã…Ÿ">ã…Ÿ</div>
                    <div class="key" data-char="ã…¢">ã…¢</div>
                    <div class="key key-special" id="key-backspace">ì§€ìš°ê¸°</div>
                    <div class="key key-special" id="key-submit">ì œì¶œ</div>
                </div>
            </div>
        </div>

        <div class="leaderboard card">
            <h2>ë¦¬ë”ë³´ë“œ</h2>
            <div id="leaderboard-container">
                <!-- ë¦¬ë”ë³´ë“œëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        const socket = io();
        const roomName = "{{ room_name }}";
        const username = "{{ username }}";
        let maxAttempts = 7;
        let currentAttempt = 0;
        let gameStatus = 'playing'; // playing, win, lose
        let currentViewingPlayer = username;
        
        const hintEmojis = {
            'carrot': 'ğŸ¥•',
            'mushroom': 'ğŸ„',
            'garlic': 'ğŸ§„',
            'eggplant': 'ğŸ†',
            'banana': 'ğŸŒ',
            'apple': 'ğŸ'
        };
        
        // ê²Œì„ ë³´ë“œ ì´ˆê¸°í™”
        function initializeGameBoard() {
            const guessGrid = document.getElementById('guess-grid');
            guessGrid.innerHTML = '';
        }
        
        // í”Œë ˆì´ì–´ ì „í™˜
        function switchPlayer(selectedUsername) {
            currentViewingPlayer = selectedUsername;
            document.getElementById('current-player').textContent = selectedUsername;
            
            // ìì‹ ì„ ì„ íƒí•  ê²½ìš°ì—ë„ ì…ë ¥ ì„¹ì…˜ì„ ë³´ì´ë„ë¡ ìˆ˜ì •
            const inputSection = document.getElementById('input-section');
            inputSection.style.display = selectedUsername === username ? 'block' : 'none';
            
            // ì„ íƒí•œ í”Œë ˆì´ì–´ì˜ ê²Œì„ ìƒíƒœ ìš”ì²­
            socket.emit('get_player_state', {
                room: roomName,
                target_username: selectedUsername
            });
            
            // í”Œë ˆì´ì–´ ëª©ë¡ UI ì—…ë°ì´íŠ¸
            updatePlayerListUI();
        }
        
        // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updatePlayerList(players) {
            const playerListContainer = document.getElementById('player-list-container');
            playerListContainer.innerHTML = '';
            
            const playerSelect = document.getElementById('player-select');
            playerSelect.innerHTML = '';
            
            // ìì‹ ì„ ì²« ë²ˆì§¸ ì˜µì…˜ìœ¼ë¡œ
            const selfOption = document.createElement('option');
            selfOption.value = username;
            selfOption.textContent = 'ë‚´ ê²Œì„';
            playerSelect.appendChild(selfOption);
            
            players.forEach(player => {
                // í”Œë ˆì´ì–´ ëª©ë¡ì— ì¶”ê°€
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                if (player.username === currentViewingPlayer) {
                    playerItem.classList.add('current');
                }
                
                if (player.status === 'win') {
                    playerItem.classList.add('win');
                } else if (player.status === 'lose') {
                    playerItem.classList.add('lose');
                }
                
                playerItem.onclick = () => switchPlayer(player.username);
                
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.username === username ? `${player.username} (ë‚˜)` : player.username;
                
                const playerStatus = document.createElement('div');
                playerStatus.className = 'player-status';
                
                let statusText = '';
                let statusIcon = '';
                
                if (player.status === 'win') {
                    statusText = 'ìŠ¹ë¦¬';
                    statusIcon = 'ğŸ†';
                } else if (player.status === 'lose') {
                    statusText = 'íŒ¨ë°°';
                    statusIcon = 'ğŸ’”';
                } else {
                    statusText = `${player.attempts}/${maxAttempts}`;
                    statusIcon = 'ğŸ®';
                }
                
                if (statusIcon) {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'status-icon';
                    iconSpan.textContent = statusIcon;
                    playerStatus.appendChild(iconSpan);
                }
                
                const statusSpan = document.createElement('span');
                statusSpan.textContent = statusText;
                playerStatus.appendChild(statusSpan);
                
                playerItem.appendChild(playerName);
                playerItem.appendChild(playerStatus);
                playerListContainer.appendChild(playerItem);
                
                // ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
                if (player.username !== username) {
                    const option = document.createElement('option');
                    option.value = player.username;
                    option.textContent = `${player.username}ì˜ ê²Œì„`;
                    playerSelect.appendChild(option);
                }
            });
        }
        
        // í”Œë ˆì´ì–´ ëª©ë¡ UI ì—…ë°ì´íŠ¸
        function updatePlayerListUI() {
            const playerItems = document.querySelectorAll('.player-item');
            playerItems.forEach(item => {
                const playerName = item.querySelector('.player-name').textContent.replace(' (ë‚˜)', '');
                if (playerName === currentViewingPlayer) {
                    item.classList.add('current');
                } else {
                    item.classList.remove('current');
                }
            });
        }
        
        // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
        function updateLeaderboard(leaderboard) {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            leaderboardContainer.innerHTML = '';
            
            if (leaderboard.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.textContent = 'ë¦¬ë”ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
                leaderboardContainer.appendChild(emptyMessage);
                return;
            }
            
            leaderboard.forEach((entry, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                const rankName = document.createElement('div');
                rankName.textContent = `${index + 1}. ${entry.username}`;
                
                const rankScore = document.createElement('div');
                rankScore.textContent = `${entry.score}ì `;
                
                leaderboardItem.appendChild(rankName);
                leaderboardItem.appendChild(rankScore);
                leaderboardContainer.appendChild(leaderboardItem);
            });
        }
        
        // í•œê¸€ ìëª¨ ë¶„í•´ í•¨ìˆ˜
        function decomposeHangul(char) {
            if (!char || char.length === 0) return null;
            
            const code = char.charCodeAt(0);
            
            // í•œê¸€ ë²”ìœ„ ì²´í¬ (ê°€-í£)
            if (code < 0xAC00 || code > 0xD7A3) return null;
            
            // í•œê¸€ ë¶„í•´ ê³„ì‚°
            const cho = Math.floor((code - 0xAC00) / (21 * 28));
            const jung = Math.floor(((code - 0xAC00) % (21 * 28)) / 28);
            const jong = (code - 0xAC00) % 28;
            
            // ì´ˆì„± ë°°ì—´
            const choSet = [
                'ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……',
                'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'
            ];
            
            // ì¤‘ì„± ë°°ì—´
            const jungSet = [
                'ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜',
                'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢',
                'ã…£'
            ];
            
            // ì¢…ì„± ë°°ì—´
            const jongSet = [
                '', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º',
                'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……',
                'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'
            ];
            
            return {
                cho: choSet[cho],
                jung: jungSet[jung],
                jong: jong > 0 ? jongSet[jong] : null
            };
        }
        
        // ë³µí•© ìëª¨ ë¶„ë¦¬ í•¨ìˆ˜
        function groupJamo(jamo) {
            // ê²¹ë°›ì¹¨ ë¶„ë¦¬
            const compoundJongMap = {
                'ã„³': ['ã„±', 'ã……'],
                'ã„µ': ['ã„´', 'ã…ˆ'],
                'ã„¶': ['ã„´', 'ã…'],
                'ã„º': ['ã„¹', 'ã„±'],
                'ã„»': ['ã„¹', 'ã…'],
                'ã„¼': ['ã„¹', 'ã…‚'],
                'ã„½': ['ã„¹', 'ã……'],
                'ã„¾': ['ã„¹', 'ã…Œ'],
                'ã„¿': ['ã„¹', 'ã…'],
                'ã…€': ['ã„¹', 'ã…'],
                'ã…„': ['ã…‚', 'ã……']
            };
            
            // ê²¹ëª¨ìŒ ë¶„ë¦¬
            const compoundJungMap = {
                'ã…˜': ['ã…—', 'ã…'],
                'ã…™': ['ã…—', 'ã…'],
                'ã…š': ['ã…—', 'ã…£'],
                'ã…': ['ã…œ', 'ã…“'],
                'ã…': ['ã…œ', 'ã…”'],
                'ã…Ÿ': ['ã…œ', 'ã…£'],
                'ã…¢': ['ã…¡', 'ã…£']
            };
            
            // ê²¹ììŒ ë¶„ë¦¬
            const compoundChoMap = {
                'ã„²': ['ã„±', 'ã„±'],
                'ã„¸': ['ã„·', 'ã„·'],
                'ã…ƒ': ['ã…‚', 'ã…‚'],
                'ã…†': ['ã……', 'ã……'],
                'ã…‰': ['ã…ˆ', 'ã…ˆ']
            };
            
            if (compoundJongMap[jamo]) return compoundJongMap[jamo];
            if (compoundJungMap[jamo]) return compoundJungMap[jamo];
            if (compoundChoMap[jamo]) return compoundChoMap[jamo];
            
            return [jamo];
        }
        
        // í‚¤ë³´ë“œ íŒíŠ¸ ì—…ë°ì´íŠ¸
        function updateKeyboard(guess, feedback) {
            for (let i = 0; i < guess.length; i++) {
                const char = guess[i];
                const jamo = decomposeHangul(char);
                if (!jamo) continue;
                
                const hint = feedback[i];
                
                // ìëª¨ìŒ ìš”ì†Œ ì°¾ê¸° (ë³µí•© ìëª¨ëŠ” ë¶„ë¦¬í•´ì„œ ì²˜ë¦¬)
                updateKeyColor(jamo.cho, hint);
                updateKeyColor(jamo.jung, hint);
                if (jamo.jong) {
                    const jongGroups = groupJamo(jamo.jong);
                    jongGroups.forEach(j => updateKeyColor(j, hint));
                }
            }
        }
        
        // í‚¤ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        function updateKeyColor(jamo, hint) {
            const keyElement = document.querySelector(`.key[data-char="${jamo}"]`);
            if (!keyElement) return;
            
            if (hint === 'carrot' || hint === 'mushroom' || hint === 'garlic') {
                // ì •í™•íˆ ì¼ì¹˜ ë˜ëŠ” ì¼ë¶€ ì¼ì¹˜í•˜ëŠ” ê²½ìš° - í™•ì • (ì£¼í™©ìƒ‰)
                keyElement.classList.add('confirmed');
                keyElement.classList.remove('excluded');
            } else if (hint === 'apple') {
                // ì™„ì „ ë¶ˆì¼ì¹˜ì¸ ê²½ìš° - ì œì™¸ (ë¹¨ê°„ìƒ‰)
                // ì´ë¯¸ í™•ì •ëœ í‚¤ëŠ” ìƒ‰ìƒ ë³€ê²½í•˜ì§€ ì•ŠìŒ
                if (!keyElement.classList.contains('confirmed')) {
                    keyElement.classList.add('excluded');
                }
            } else {
                // ê·¸ ì™¸ì˜ ê²½ìš° - ê¸°ë³¸ ìƒ‰ìƒ (í•˜ì–€ìƒ‰)
                keyElement.classList.remove('confirmed', 'excluded');
            }
        }
        
        // í‚¤ë³´ë“œ ì´ˆê¸°í™”
        function resetKeyboard() {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('confirmed', 'excluded');
            });
        }
        
        // ì¶”ì¸¡ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function getHintEmoji(type) {
            return hintEmojis[type] || 'â“';
        }
            
        function updateGuessResult(attempt, guess, feedback) {
            const guessGrid = document.getElementById('guess-grid');
            
            // ê²°ê³¼ ì¹´ë“œ ìƒì„±
            const resultDiv = document.createElement('div');
            resultDiv.className = 'guess-result card';
            
            // ì¶”ì¸¡ ë‹¨ì–´ í‘œì‹œ
            const guessText = document.createElement('span');
            guessText.className = 'guess-text';
            guessText.textContent = `${attempt + 1}. ${guess}`;
            
            // íŒíŠ¸ ì»¨í…Œì´ë„ˆ
            const hintContainer = document.createElement('div');
            hintContainer.className = 'hint-container';
            
            // íŒíŠ¸ ì´ëª¨ì§€ ì¶”ê°€
            feedback.forEach(hint => {
                const hintSpan = document.createElement('span');
                hintSpan.className = 'hint-icon';
                hintSpan.textContent = getHintEmoji(hint);
                
                // íˆ´íŒ ì¶”ê°€
                hintSpan.title = getHintDescription(hint);
                
                hintContainer.appendChild(hintSpan);
            });
            
            resultDiv.appendChild(guessText);
            resultDiv.appendChild(hintContainer);
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¡œ ì¶”ê°€
            resultDiv.style.opacity = '0';
            guessGrid.insertBefore(resultDiv, guessGrid.firstChild);
            
            // í˜ì´ë“œ ì¸ íš¨ê³¼
            setTimeout(() => {
                resultDiv.style.transition = 'opacity 0.3s ease';
                resultDiv.style.opacity = '1';
            }, 50);
            
            // í‚¤ë³´ë“œ íŒíŠ¸ ì—…ë°ì´íŠ¸
            if (currentViewingPlayer === username) {
                updateKeyboard(guess, feedback);
            }
        }
        
        function getHintDescription(hint) {
            const descriptions = {
                'carrot': 'ì •í™•íˆ ì¼ì¹˜',
                'mushroom': 'ì²« ììŒ í¬í•¨ 2ê°œ ì´ìƒ ì¼ì¹˜',
                'garlic': 'ì²« ììŒ ë¶ˆì¼ì¹˜, ë‚˜ë¨¸ì§€ 2ê°œ ì´ìƒ ì¼ì¹˜',
                'eggplant': 'ììŒÂ·ëª¨ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì¼ì¹˜',
                'banana': 'ë°˜ëŒ€í¸ ê¸€ìì—ì„œ 1ê°œ ì´ìƒ ì¼ì¹˜',
                'apple': 'ì™„ì „ ë¶ˆì¼ì¹˜'
            };
            return descriptions[hint] || 'ì•Œ ìˆ˜ ì—†ëŠ” íŒíŠ¸';
        }

        // ì…ë ¥ í•„ë“œ ê°œì„ 
        document.getElementById('guess-input').addEventListener('input', function(e) {
            const input = e.target;
            const value = input.value;
            
            // í•œê¸€ë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡
            input.value = value.replace(/[^ê°€-í£]/g, '');
            
            // 2ê¸€ì ì œí•œ
            if (value.length > 2) {
                input.value = value.slice(0, 2);
            }
        });

        // ê²Œì„ ìƒíƒœ í‘œì‹œ ê°œì„ 
        function updateGameStatus(status, message) {
            const statusElement = document.getElementById('game-status');
            const messageElement = document.getElementById('game-over-message');
            
            statusElement.textContent = status;
            if (message) {
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                
                // ìŠ¹ë¦¬/íŒ¨ë°°ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
                messageElement.className = 'game-over-message';
                if (status.includes('ìŠ¹ë¦¬')) {
                    messageElement.classList.add('win');
                } else if (status.includes('íŒ¨ë°°')) {
                    messageElement.classList.add('lose');
                }
            }
        }
        
        // ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ê²Œì„ ë³´ë“œ ë¡œë”©
        function loadPlayerGameBoard(data) {
            const guessGrid = document.getElementById('guess-grid');
            guessGrid.innerHTML = '';
            
            // í‚¤ë³´ë“œ ì´ˆê¸°í™” (ìì‹ ì˜ ê²Œì„ì¸ ê²½ìš°ë§Œ)
            if (data.username === username) {
                resetKeyboard();
            }
            
            // ê°ê°ì˜ ì¶”ì¸¡ê³¼ í”¼ë“œë°± íˆìŠ¤í† ë¦¬ í‘œì‹œ
            if (data.feedback_history && data.feedback_history.length > 0) {
                data.feedback_history.forEach((history, index) => {
                    updateGuessResult(index, history.guess, history.feedback);
                });
            }
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (data.status === 'win') {
                document.getElementById('game-status').textContent = 'ìŠ¹ë¦¬!';
            } else if (data.status === 'lose') {
                document.getElementById('game-status').textContent = 'íŒ¨ë°°';
            } else {
                document.getElementById('game-status').textContent = 'ì§„í–‰ ì¤‘';
            }
            
            // ë‚¨ì€ ì‹œë„ íšŸìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('attempts-count').textContent = maxAttempts - data.attempts;
        }
        
        // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        socket.on('connect', () => {
            socket.emit('join', { room: roomName, username: username });
        });
        
        socket.on('room_state', (data) => {
            maxAttempts = data.max_attempts;
            document.getElementById('attempts-count').textContent = maxAttempts;
            updatePlayerList(data.players);
        });
        
        socket.on('player_joined', (data) => {
            console.log(`${data.username} ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        });
        
        socket.on('players_update', (data) => {
            updatePlayerList(data.players);
        });
        
        socket.on('guess_result', (data) => {
            if (data.username === username) {
                // ìì‹ ì˜ ê²Œì„ì¸ ê²½ìš°
                currentAttempt = data.attempts;
                document.getElementById('attempts-count').textContent = data.remaining;
                updateGuessResult(data.attempts - 1, data.guess, data.feedback);
            } else if (data.username === currentViewingPlayer) {
                // í˜„ì¬ ê´€ì „ ì¤‘ì¸ í”Œë ˆì´ì–´ì˜ ê²Œì„ì¸ ê²½ìš°
                document.getElementById('attempts-count').textContent = data.remaining;
                updateGuessResult(data.attempts - 1, data.guess, data.feedback);
            }
        });
        
        socket.on('game_over', (data) => {
            if (data.username === username) {
                gameStatus = data.result;
                
                if (data.result === 'win') {
                    document.getElementById('game-status').textContent = 'ìŠ¹ë¦¬!';
                    document.getElementById('game-over-message').textContent = `ì¶•í•˜í•©ë‹ˆë‹¤! ì •ë‹µ "${data.correct_word}"ì„(ë¥¼) ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ì ìˆ˜: ${data.score}ì `;
                } else {
                    document.getElementById('game-status').textContent = 'íŒ¨ë°°';
                    document.getElementById('game-over-message').textContent = `ì•„ì‰½ìŠµë‹ˆë‹¤. ì •ë‹µì€ "${data.correct_word}" ì…ë‹ˆë‹¤.`;
                }
                
                if (currentViewingPlayer === username) {
                    document.getElementById('game-over-message').style.display = 'block';
                    document.getElementById('restart-btn').style.display = 'block';
                    document.getElementById('guess-input').disabled = true;
                    document.getElementById('submit-btn').disabled = true;
                }
            } else if (data.username === currentViewingPlayer) {
                // í˜„ì¬ ê´€ì „ ì¤‘ì¸ í”Œë ˆì´ì–´ì˜ ê²Œì„ì´ ì¢…ë£Œëœ ê²½ìš°
                if (data.result === 'win') {
                    document.getElementById('game-status').textContent = 'ìŠ¹ë¦¬!';
                    document.getElementById('game-over-message').textContent = `${data.username}ë‹˜ì´ ì •ë‹µ "${data.correct_word}"ì„(ë¥¼) ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!`;
                } else {
                    document.getElementById('game-status').textContent = 'íŒ¨ë°°';
                    document.getElementById('game-over-message').textContent = `${data.username}ë‹˜ì˜ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë‹µì€ "${data.correct_word}" ì…ë‹ˆë‹¤.`;
                }
                
                document.getElementById('game-over-message').style.display = 'block';
            }
        });
        
        socket.on('leaderboard_update', (data) => {
            updateLeaderboard(data.leaderboard);
        });
        
        socket.on('player_state_update', (data) => {
            currentViewingPlayer = data.username;
            loadPlayerGameBoard(data);
            
            // ê²Œì„ ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
            if (data.status === 'win' || data.status === 'lose') {
                document.getElementById('game-over-message').style.display = 'block';
                
                if (data.status === 'win') {
                    document.getElementById('game-over-message').textContent = `${data.username}ë‹˜ì´ ê²Œì„ì—ì„œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!`;
                } else {
                    document.getElementById('game-over-message').textContent = `${data.username}ë‹˜ì˜ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                }
            } else {
                document.getElementById('game-over-message').style.display = 'none';
            }
            
            // í‚¤ë³´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ìì‹ ì˜ ê²Œì„ì¸ ê²½ìš°)
            if (data.username === username && data.feedback_history) {
                resetKeyboard();
                data.feedback_history.forEach(history => {
                    updateKeyboard(history.guess, history.feedback);
                });
            }
        });
        
        socket.on('error', (data) => {
            alert(data.message);
            const guessInput = document.getElementById('guess-input');
            guessInput.classList.add('shake');
            setTimeout(() => {
                guessInput.classList.remove('shake');
            }, 500);
        });
        
        socket.on('game_restarted', (data) => {
            if (data.username === username) {
                gameStatus = 'playing';
                currentAttempt = 0;
                document.getElementById('game-status').textContent = 'ì§„í–‰ ì¤‘';
                document.getElementById('attempts-count').textContent = maxAttempts;
                document.getElementById('game-over-message').style.display = 'none';
                document.getElementById('restart-btn').style.display = 'none';
                document.getElementById('guess-input').disabled = false;
                document.getElementById('submit-btn').disabled = false;
                initializeGameBoard();
                resetKeyboard();
            } else if (data.username === currentViewingPlayer) {
                // ê´€ì „ ì¤‘ì¸ í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ì¬ì‹œì‘í•œ ê²½ìš°
                document.getElementById('game-status').textContent = 'ì§„í–‰ ì¤‘';
                document.getElementById('attempts-count').textContent = maxAttempts;
                document.getElementById('game-over-message').style.display = 'none';
                initializeGameBoard();
            }
        });
        
        // ë‹¨ì–´ ì œì¶œ ì´ë²¤íŠ¸
        document.getElementById('submit-btn').addEventListener('click', () => {
            const guessInput = document.getElementById('guess-input');
            const guess = guessInput.value.trim();
            
            if (guess.length === 2) {
                socket.emit('submit_guess', { room: roomName, username: username, guess: guess });
                guessInput.value = '';
            } else {
                guessInput.classList.add('shake');
                setTimeout(() => {
                    guessInput.classList.remove('shake');
                }, 500);
                alert('ë‘ ê¸€ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            }
        });
        
        // ì—”í„° í‚¤ë¡œ ì œì¶œ
        document.getElementById('guess-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submit-btn').click();
            }
        });
        
        // ìƒˆ ê²Œì„ ì‹œì‘
        document.getElementById('restart-btn').addEventListener('click', () => {
            socket.emit('restart_game', { room: roomName, username: username });
        });
        
        // ê°€ìƒ í‚¤ë³´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        function initializeKeyboard() {
            // ê° í‚¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.querySelectorAll('.key').forEach(key => {
                key.addEventListener('click', function() {
                    if (currentViewingPlayer !== username) return;
                    if (gameStatus !== 'playing') return;
                    
                    const char = this.getAttribute('data-char');
                    const input = document.getElementById('guess-input');
                    
                    // ì»¤ì„œ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const cursorPos = input.selectionStart;
                    const value = input.value;
                    
                    // ì„ íƒëœ ìœ„ì¹˜ì— ë¬¸ì ì‚½ì…
                    input.value = value.substring(0, cursorPos) + char + value.substring(input.selectionEnd);
                    
                    // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
                    const newPos = cursorPos + char.length;
                    input.setSelectionRange(newPos, newPos);
                    
                    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ì£¼ê¸°
                    input.focus();
                });
            });
        }
        
        // ì´ˆê¸°í™”
        window.onload = () => {
            currentViewingPlayer = username;
            gameStatus = 'playing';
            currentAttempt = 0;
            
            initializeGameBoard();
            initializeKeyboard();
        };
    </script>
</body>
</html>